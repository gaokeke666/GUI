# 测试知识总结 - 背诵版

## 一、测试的三种类型

### 1. 单元测试 (Unit Test)
- **定义**: 测试单个函数或类的最小单元
- **特点**: 快速、独立、不依赖外部资源
- **目的**: 验证单个功能是否正确
- **示例**: 测试图像缩放计算 800×600 放大2倍 = 1600×1200

### 2. 集成测试 (Integration Test)
- **定义**: 测试多个模块组合工作
- **特点**: 验证模块间的数据传递和交互
- **目的**: 确保模块协同工作正常
- **示例**: 测试 UI设置 → 配置对象 → 处理模块 的数据流

### 3. 用户验收测试 (UAT)
- **定义**: 模拟真实用户操作场景
- **特点**: 端到端的完整流程测试
- **目的**: 发现用户体验问题和潜在bug
- **示例**: 打开图片 → 设置参数 → 处理 → 保存结果

---

## 二、核心概念 (必背)
自动化特性:

参数化测试: 一个测试自动运行多组数据
Fixture: 自动准备和清理测试环境
Mock: 自动模拟GPU等外部依赖
信号测试: 自动验证Qt信号机制


### 1. Fixture (测试夹具)
```python
@pytest.fixture
def sample_image_path():
    """提供可复用的测试资源"""
    return "path/to/test.jpg"
```
- **作用**: 准备测试所需的数据或环境
- **特点**: 可复用、自动清理
- **使用**: 作为测试函数的参数传入

### 2. Mock (模拟对象)
```python
@pytest.fixture
def mock_config():
    """替换真实对象，避免依赖外部资源"""
    config.CanWaifu2x = False  # 禁用GPU
    yield config
    config.CanWaifu2x = True   # 恢复原状
```
- **作用**: 隔离外部依赖(GPU、数据库、网络)
- **特点**: 让测试更快、更可靠、更可控
- **使用**: 替换真实对象，模拟其行为

### 3. Assert (断言)
```python
assert result == expected  # 验证结果
```
- **作用**: 验证实际结果是否符合预期
- **规则**: 如果条件为False，测试失败
- **常用**: `assert`, `assert ==`, `assert in`

### 4. 参数化测试
```python
@pytest.mark.parametrize("input,expected", [
    (100, 200),
    (200, 400),
])
def test_double(input, expected):
    assert input * 2 == expected
```
- **作用**: 用多组数据测试同一功能
- **优点**: 避免重复代码，提高覆盖率

---

## 三、测试结构 - AAA模式 (必背)

```python
def test_example(self):
    # 1. Arrange (准备) - 设置测试数据
    width = 800
    scale = 2.0
    expected = 1600
    
    # 2. Act (执行) - 调用被测函数
    result = int(width * scale)
    
    # 3. Assert (验证) - 检查结果
    assert result == expected
```

**记忆口诀**: 准备-执行-验证 (Arrange-Act-Assert)

---

## 四、项目测试内容总结

### 单元测试 (test_image_utils.py)
1. ✅ **缩放计算**: 2倍、4倍缩放是否准确
2. ✅ **宽高比保持**: 缩放后比例不变
3. ✅ **参数化测试**: 多种缩放场景
4. ✅ **固定尺寸模式**: scale=0时的计算
5. ✅ **格式验证**: jpg/png/webp/bmp支持
6. ✅ **降噪等级**: -1到3的有效范围
7. ✅ **模型参数**: 字典结构和类型检查

### 单元测试 (test_task_manager.py)
1. ✅ **任务ID自增**: 每个任务ID递增
2. ✅ **任务存储**: 正确保存到字典
3. ✅ **回调函数**: 保存和调用回调
4. ✅ **任务分组**: cleanFlag分组管理
5. ✅ **任务取消**: 删除任务和清理
6. ✅ **信号机制**: Signal定义和连接
7. ✅ **线程安全**: Queue的并发处理

### 集成测试 (test_workflow.py)
1. ✅ **设置到处理**: GPU选择传递
2. ✅ **UI到任务**: 按钮点击创建任务
3. ✅ **任务到回调**: 回调函数调用
4. ✅ **端到端流程**: 完整工作流程
5. ✅ **多任务并发**: 5个任务同时处理
6. ✅ **错误处理**: 异常和空数据
7. ✅ **任务取消**: 单个和批量取消

---

## 五、pytest 配置 (必背)

### pytest.ini 关键配置
```ini
[pytest]
python_files = test_*.py      # 测试文件命名
python_classes = Test*        # 测试类命名
python_functions = test_*     # 测试函数命名
testpaths = tests             # 测试目录
```

### 标记 (Markers)
- `@pytest.mark.unit` - 单元测试
- `@pytest.mark.integration` - 集成测试
- `@pytest.mark.uat` - 用户验收测试
- `@pytest.mark.slow` - 慢速测试
- `@pytest.mark.gpu` - 需要GPU的测试

---

## 六、常用命令 (必背)

```bash
# 运行所有测试
pytest

# 运行单元测试
pytest tests/unit/ -v

# 运行特定文件
pytest tests/unit/test_image_utils.py -v

# 运行特定测试
pytest tests/unit/test_image_utils.py::TestImageSizeCalculation::test_scale_calculation_2x -v

# 使用标记
pytest -m unit          # 只运行单元测试
pytest -m "not gpu"     # 排除GPU测试

# 显示详细输出
pytest -v               # 详细模式
pytest -s               # 显示print输出
pytest -vv              # 超详细模式

# 只运行失败的测试
pytest --lf

# 生成覆盖率报告
pytest --cov=src --cov-report=html
```

---

## 七、测试最佳实践 (必背8条)

1. **测试应该独立** - 不依赖其他测试的结果
2. **测试应该快速** - 单元测试毫秒级完成
3. **测试应该可重复** - 多次运行结果相同
4. **测试名称清晰** - 一看就知道测试什么
5. **一个测试一个断言** - 只验证一个行为
6. **使用Mock隔离依赖** - 避免依赖GPU/网络
7. **测试边界条件** - 最小值、最大值、空值
8. **保持测试简单** - 测试代码比被测代码简单

---

## 八、conftest.py 的三个Fixture (必背)

### 1. qapp - Qt应用实例
```python
@pytest.fixture(scope="session")
def qapp():
    """整个测试会话只创建一次QApplication"""
    app = QApplication.instance()
    if app is None:
        app = QApplication(sys.argv)
    yield app
```
- **作用**: 提供Qt环境，所有Qt测试都需要
- **范围**: session级别，全局共享

### 2. sample_image_path - 测试图片路径
```python
@pytest.fixture
def sample_image_path():
    """提供测试用的示例图片路径"""
    test_dir = os.path.dirname(__file__)
    return os.path.join(test_dir, "test_data", "sample.jpg")
```
- **作用**: 提供测试图片的路径
- **范围**: function级别，每个测试独立

### 3. mock_config - 模拟配置
```python
@pytest.fixture
def mock_config():
    """模拟配置对象，禁用GPU"""
    from conf import config
    original_can_waifu2x = config.CanWaifu2x
    config.CanWaifu2x = False  # 测试时禁用GPU
    yield config
    config.CanWaifu2x = original_can_waifu2x  # 恢复
```
- **作用**: 测试时禁用GPU，避免硬件依赖
- **特点**: 自动恢复原始配置

---

## 九、测试覆盖率目标

- **单元测试**: > 80% 代码覆盖率
- **集成测试**: 覆盖主要业务流程
- **UAT测试**: 覆盖所有用户场景

---

## 十、运行频率

- **单元测试**: 每次代码修改后立即运行
- **集成测试**: 每次功能完成后运行
- **UAT测试**: 每次发布前运行

---

## 快速记忆卡片

### 测试三要素
1. **输入** (Input) - 给什么数据
2. **执行** (Execute) - 调用什么函数
3. **验证** (Verify) - 检查什么结果

### 测试金字塔
```
       /\
      /  \  UAT (少量，慢，端到端)
     /____\
    /      \
   / 集成测试 \ (中等数量，中速)
  /__________\
 /            \
/  单元测试     \ (大量，快速，独立)
/______________\
```

### 记忆口诀
- **AAA**: 准备-执行-验证
- **FIRST原则**: Fast(快), Independent(独立), Repeatable(可重复), Self-validating(自验证), Timely(及时)
- **Mock三步**: 替换-模拟-恢复

---

## 最后：测试的价值

1. **发现bug** - 在用户使用前发现问题
2. **防止回归** - 修改代码后确保旧功能正常
3. **文档作用** - 展示如何使用功能
4. **重构信心** - 有测试保护，放心优化代码

---

**记住**: 好的测试 = 简单 + 快速 + 可靠 + 易懂

**测试不是负担，是保护伞！** 🛡️
