# è‡ªåŠ¨åŒ–æµ‹è¯•æ ¸å¿ƒæŠ€æœ¯è¯¦è§£

## ä¸€ã€å‚æ•°åŒ–æµ‹è¯• (Parametrize)

### åŸç†
**ä¸€æ¬¡ç¼–å†™æµ‹è¯•é€»è¾‘ï¼Œè‡ªåŠ¨ç”¨å¤šç»„æ•°æ®é‡å¤æ‰§è¡Œ**

### é—®é¢˜åœºæ™¯
å‡è®¾è¦æµ‹è¯•å›¾åƒç¼©æ”¾åŠŸèƒ½ï¼Œéœ€è¦æµ‹è¯•å¤šç§å°ºå¯¸ï¼š
- 100x100 æ”¾å¤§2å€ = 200x200
- 640x480 æ”¾å¤§3å€ = 1920x1440
- 1024x768 æ”¾å¤§1.5å€ = 1536x1152
- 800x600 æ”¾å¤§4å€ = 3200x2400

### ä¼ ç»Ÿæ–¹å¼ (é‡å¤ä»£ç )
```python
def test_scale_100x100(self):
    result_w = int(100 * 2.0)
    result_h = int(100 * 2.0)
    assert result_w == 200
    assert result_h == 200

def test_scale_640x480(self):
    result_w = int(640 * 3.0)
    result_h = int(480 * 3.0)
    assert result_w == 1920
    assert result_h == 1440

def test_scale_1024x768(self):
    result_w = int(1024 * 1.5)
    result_h = int(768 * 1.5)
    assert result_w == 1536
    assert result_h == 1152

def test_scale_800x600(self):
    result_w = int(800 * 4.0)
    result_h = int(600 * 4.0)
    assert result_w == 3200
    assert result_h == 2400
```
**é—®é¢˜**: é‡å¤ä»£ç å¤šï¼Œç»´æŠ¤å›°éš¾

### å‚æ•°åŒ–æ–¹å¼ (è‡ªåŠ¨åŒ–)
```python
@pytest.mark.parametrize("width,height,scale,expected_w,expected_h", [
    (100, 100, 2.0, 200, 200),        # ç¬¬1ç»„æ•°æ®
    (640, 480, 3.0, 1920, 1440),      # ç¬¬2ç»„æ•°æ®
    (1024, 768, 1.5, 1536, 1152),     # ç¬¬3ç»„æ•°æ®
    (800, 600, 4.0, 3200, 2400),      # ç¬¬4ç»„æ•°æ®
])
def test_multiple_scale_scenarios(self, width, height, scale, expected_w, expected_h):
    """ä¸€ä¸ªæµ‹è¯•å‡½æ•°ï¼Œè‡ªåŠ¨è¿è¡Œ4æ¬¡"""
    result_w = int(width * scale)
    result_h = int(height * scale)
    
    assert result_w == expected_w
    assert result_h == expected_h
```

### å·¥ä½œåŸç†
```
1. pytest è¯»å– @pytest.mark.parametrize è£…é¥°å™¨
2. è§£æå‚æ•°åˆ—è¡¨: ["width", "height", "scale", "expected_w", "expected_h"]
3. è§£ææ•°æ®åˆ—è¡¨: [(100, 100, 2.0, 200, 200), ...]
4. è‡ªåŠ¨ç”Ÿæˆ4ä¸ªæµ‹è¯•ç”¨ä¾‹:
   - test_multiple_scale_scenarios[100-100-2.0-200-200]
   - test_multiple_scale_scenarios[640-480-3.0-1920-1440]
   - test_multiple_scale_scenarios[1024-768-1.5-1536-1152]
   - test_multiple_scale_scenarios[800-600-4.0-3200-2400]
5. ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹
6. æŠ¥å‘Šæ¯ä¸ªç”¨ä¾‹çš„é€šè¿‡/å¤±è´¥çŠ¶æ€
```

### å®é™…è¿ç”¨ - é™å™ªç­‰çº§æµ‹è¯•
```python
@pytest.mark.parametrize("noise_level", [-1, 0, 1, 2, 3])
def test_valid_noise_levels(self, noise_level):
    """æµ‹è¯•5ä¸ªæœ‰æ•ˆçš„é™å™ªç­‰çº§"""
    valid_levels = [-1, 0, 1, 2, 3]
    assert noise_level in valid_levels
```

**æ‰§è¡Œç»“æœ**:
```
test_valid_noise_levels[-1] PASSED
test_valid_noise_levels[0] PASSED
test_valid_noise_levels[1] PASSED
test_valid_noise_levels[2] PASSED
test_valid_noise_levels[3] PASSED
```

### ä¼˜åŠ¿
âœ… **å‡å°‘é‡å¤ä»£ç **: 1ä¸ªå‡½æ•°æ›¿ä»£Nä¸ªå‡½æ•°
âœ… **æ˜“äºæ‰©å±•**: æ·»åŠ æ–°æµ‹è¯•æ•°æ®åªéœ€åŠ ä¸€è¡Œ
âœ… **æ¸…æ™°çš„æµ‹è¯•æŠ¥å‘Š**: æ¯ç»„æ•°æ®ç‹¬ç«‹æ˜¾ç¤ºç»“æœ
âœ… **æé«˜è¦†ç›–ç‡**: è½»æ¾æµ‹è¯•æ›´å¤šåœºæ™¯

---

## äºŒã€Fixture (æµ‹è¯•å¤¹å…·)

### åŸç†
**è‡ªåŠ¨å‡†å¤‡æµ‹è¯•ç¯å¢ƒï¼Œæµ‹è¯•å®Œæˆåè‡ªåŠ¨æ¸…ç†**

### é—®é¢˜åœºæ™¯
æ¯ä¸ªæµ‹è¯•éƒ½éœ€è¦:
1. åˆ›å»ºQtåº”ç”¨å®ä¾‹
2. å‡†å¤‡æµ‹è¯•å›¾ç‰‡è·¯å¾„
3. é…ç½®æµ‹è¯•ç¯å¢ƒ
4. æµ‹è¯•å®Œæˆåæ¸…ç†èµ„æº

### ä¼ ç»Ÿæ–¹å¼ (æ‰‹åŠ¨å‡†å¤‡å’Œæ¸…ç†)
```python
def test_load_image(self):
    # æ¯ä¸ªæµ‹è¯•éƒ½è¦æ‰‹åŠ¨å‡†å¤‡
    app = QApplication.instance()
    if app is None:
        app = QApplication(sys.argv)
    
    test_dir = os.path.dirname(__file__)
    image_path = os.path.join(test_dir, "test_data", "sample.jpg")
    
    # æµ‹è¯•é€»è¾‘
    assert os.path.exists(image_path)
    
    # æ‰‹åŠ¨æ¸…ç†
    # ...

def test_process_image(self):
    # åˆè¦é‡å¤å‡†å¤‡ä¸€æ¬¡
    app = QApplication.instance()
    if app is None:
        app = QApplication(sys.argv)
    
    test_dir = os.path.dirname(__file__)
    image_path = os.path.join(test_dir, "test_data", "sample.jpg")
    
    # æµ‹è¯•é€»è¾‘
    # ...
```
**é—®é¢˜**: æ¯ä¸ªæµ‹è¯•éƒ½é‡å¤å‡†å¤‡ä»£ç 

### Fixtureæ–¹å¼ (è‡ªåŠ¨åŒ–)
```python
# å®šä¹‰Fixture (åœ¨conftest.pyä¸­)
@pytest.fixture(scope="session")
def qapp():
    """åˆ›å»ºQtåº”ç”¨ï¼Œæ•´ä¸ªæµ‹è¯•ä¼šè¯å…±äº«"""
    app = QApplication.instance()
    if app is None:
        app = QApplication(sys.argv)
    yield app  # æä¾›ç»™æµ‹è¯•ä½¿ç”¨
    # yieldåé¢çš„ä»£ç åœ¨æµ‹è¯•å®Œæˆåè‡ªåŠ¨æ‰§è¡Œ (æ¸…ç†)

@pytest.fixture
def sample_image_path():
    """æä¾›æµ‹è¯•å›¾ç‰‡è·¯å¾„"""
    test_dir = os.path.dirname(__file__)
    return os.path.join(test_dir, "test_data", "sample.jpg")

# ä½¿ç”¨Fixture (åœ¨æµ‹è¯•æ–‡ä»¶ä¸­)
def test_load_image(qapp, sample_image_path):
    """pytestè‡ªåŠ¨æ³¨å…¥qappå’Œsample_image_path"""
    # ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€æ‰‹åŠ¨å‡†å¤‡
    assert os.path.exists(sample_image_path)

def test_process_image(qapp, sample_image_path):
    """è‡ªåŠ¨è·å–ç›¸åŒçš„èµ„æº"""
    # ç›´æ¥ä½¿ç”¨
    # ...
```

### å·¥ä½œåŸç†
```
æµ‹è¯•æ‰§è¡Œæµç¨‹:
1. pytestå‘ç°æµ‹è¯•å‡½æ•° test_load_image(qapp, sample_image_path)
2. åˆ†æå‚æ•°: qapp, sample_image_path
3. æŸ¥æ‰¾å¯¹åº”çš„@pytest.fixture
4. æ‰§è¡Œfixtureå‡½æ•°:
   - æ‰§è¡Œqapp()ï¼Œåˆ›å»ºQtåº”ç”¨
   - æ‰§è¡Œsample_image_path()ï¼Œè·å–è·¯å¾„
5. å°†è¿”å›å€¼æ³¨å…¥æµ‹è¯•å‡½æ•°
6. æ‰§è¡Œæµ‹è¯•å‡½æ•°
7. æµ‹è¯•å®Œæˆåï¼Œæ‰§è¡Œyieldåé¢çš„æ¸…ç†ä»£ç 
```

### Fixtureçš„Scope (ä½œç”¨åŸŸ)

#### 1. function (é»˜è®¤) - æ¯ä¸ªæµ‹è¯•å‡½æ•°ç‹¬ç«‹
```python
@pytest.fixture  # scope="function"
def temp_file():
    """æ¯ä¸ªæµ‹è¯•åˆ›å»ºæ–°æ–‡ä»¶"""
    file = open("temp.txt", "w")
    yield file
    file.close()  # æ¯ä¸ªæµ‹è¯•ååˆ é™¤
    os.remove("temp.txt")

def test_1(temp_file):  # åˆ›å»ºtemp.txt
    temp_file.write("test1")
    # æµ‹è¯•å®Œæˆåè‡ªåŠ¨åˆ é™¤

def test_2(temp_file):  # é‡æ–°åˆ›å»ºtemp.txt
    temp_file.write("test2")
    # æµ‹è¯•å®Œæˆåè‡ªåŠ¨åˆ é™¤
```

#### 2. session - æ•´ä¸ªæµ‹è¯•ä¼šè¯å…±äº«
```python
@pytest.fixture(scope="session")
def qapp():
    """æ‰€æœ‰æµ‹è¯•å…±äº«ä¸€ä¸ªQtåº”ç”¨"""
    app = QApplication(sys.argv)
    yield app
    # æ‰€æœ‰æµ‹è¯•å®Œæˆåæ‰æ¸…ç†

def test_1(qapp):  # ä½¿ç”¨å…±äº«çš„app
    pass

def test_2(qapp):  # ä½¿ç”¨åŒä¸€ä¸ªapp
    pass
```

### å®é™…è¿ç”¨ - Mocké…ç½®
```python
@pytest.fixture
def mock_config():
    """è‡ªåŠ¨å‡†å¤‡æµ‹è¯•é…ç½®ï¼Œæµ‹è¯•åè‡ªåŠ¨æ¢å¤"""
    from conf import config
    
    # 1. ä¿å­˜åŸå§‹å€¼
    original_can_waifu2x = config.CanWaifu2x
    original_gpu = config.Gpu
    
    # 2. è®¾ç½®æµ‹è¯•å€¼
    config.CanWaifu2x = False  # ç¦ç”¨GPU
    config.Gpu = -1
    
    # 3. æä¾›ç»™æµ‹è¯•ä½¿ç”¨
    yield config
    
    # 4. æµ‹è¯•å®Œæˆåè‡ªåŠ¨æ¢å¤
    config.CanWaifu2x = original_can_waifu2x
    config.Gpu = original_gpu

def test_without_gpu(mock_config):
    """è‡ªåŠ¨ä½¿ç”¨æµ‹è¯•é…ç½®"""
    assert mock_config.CanWaifu2x == False
    # æµ‹è¯•å®Œæˆåè‡ªåŠ¨æ¢å¤åŸå§‹é…ç½®
```

### ä¼˜åŠ¿
âœ… **è‡ªåŠ¨å‡†å¤‡**: æ— éœ€æ‰‹åŠ¨åˆå§‹åŒ–
âœ… **è‡ªåŠ¨æ¸…ç†**: é˜²æ­¢èµ„æºæ³„æ¼
âœ… **ä»£ç å¤ç”¨**: å¤šä¸ªæµ‹è¯•å…±äº«åŒä¸€å‡†å¤‡é€»è¾‘
âœ… **ä¾èµ–æ³¨å…¥**: pytestè‡ªåŠ¨ç®¡ç†ä¾èµ–å…³ç³»

---

## ä¸‰ã€Mock (æ¨¡æ‹Ÿå¯¹è±¡)

### åŸç†
**ç”¨å‡å¯¹è±¡æ›¿æ¢çœŸå®å¯¹è±¡ï¼Œé¿å…ä¾èµ–å¤–éƒ¨èµ„æº**

### é—®é¢˜åœºæ™¯
æµ‹è¯•å›¾åƒå¤„ç†åŠŸèƒ½æ—¶:
- âŒ éœ€è¦çœŸå®çš„GPUç¡¬ä»¶
- âŒ éœ€è¦ç½‘ç»œè¿æ¥
- âŒ éœ€è¦è¯»å†™æ–‡ä»¶ç³»ç»Ÿ
- âŒ æµ‹è¯•æ…¢ã€ä¸ç¨³å®šã€ä¾èµ–ç¯å¢ƒ

### ä¸ºä»€ä¹ˆéœ€è¦Mockï¼Ÿ

#### åœºæ™¯1: GPUä¾èµ–
```python
def process_image(image_data):
    """çœŸå®å‡½æ•°éœ€è¦GPU"""
    if config.CanWaifu2x:
        # è°ƒç”¨GPUè¿›è¡Œå¤„ç† (éœ€è¦çœŸå®ç¡¬ä»¶)
        result = waifu2x_process(image_data)
        return result
    return None
```

**é—®é¢˜**:
- æµ‹è¯•æœºå™¨å¯èƒ½æ²¡æœ‰GPU
- GPUå¤„ç†å¾ˆæ…¢ (å‡ ç§’åˆ°å‡ åˆ†é’Ÿ)
- æµ‹è¯•å¤±è´¥å¯èƒ½æ˜¯GPUé©±åŠ¨é—®é¢˜ï¼Œä¸æ˜¯ä»£ç é—®é¢˜

#### åœºæ™¯2: ç½‘ç»œä¾èµ–
```python
def download_model():
    """ä»ç½‘ç»œä¸‹è½½æ¨¡å‹"""
    response = requests.get("https://example.com/model.bin")
    return response.content
```

**é—®é¢˜**:
- ç½‘ç»œä¸ç¨³å®š
- ä¸‹è½½æ…¢
- æœåŠ¡å™¨å¯èƒ½å®•æœº

### Mockæ–¹å¼ (è‡ªåŠ¨åŒ–)

#### 1. Mocké…ç½®å¯¹è±¡
```python
@pytest.fixture
def mock_config():
    """æ¨¡æ‹Ÿé…ç½®ï¼Œç¦ç”¨GPU"""
    from conf import config
    original = config.CanWaifu2x
    
    config.CanWaifu2x = False  # ç”¨Falseæ›¿æ¢çœŸå®å€¼
    yield config
    
    config.CanWaifu2x = original

def test_without_gpu(mock_config):
    """æµ‹è¯•æ—¶ä¸éœ€è¦çœŸå®GPU"""
    assert mock_config.CanWaifu2x == False
    # ä»£ç é€»è¾‘æ­£ç¡®å³å¯ï¼Œä¸ä¾èµ–ç¡¬ä»¶
```

#### 2. Mockå‡½æ•°è°ƒç”¨
```python
from unittest.mock import Mock, patch

def test_task_submission(self):
    """æ¨¡æ‹Ÿä»»åŠ¡æäº¤"""
    # åˆ›å»ºMockå¯¹è±¡
    mock_add_task = Mock(return_value=1001)
    
    # è°ƒç”¨Mockå¯¹è±¡
    task_id = mock_add_task(
        b"image_data",
        {'scale': 2.0},
        callback_function
    )
    
    # éªŒè¯
    assert task_id == 1001  # Mockè¿”å›çš„å‡å€¼
    mock_add_task.assert_called_once()  # éªŒè¯è¢«è°ƒç”¨äº†1æ¬¡
```

#### 3. Mockå›è°ƒå‡½æ•°
```python
def test_callback_invocation(self):
    """æµ‹è¯•å›è°ƒæ˜¯å¦è¢«è°ƒç”¨"""
    # åˆ›å»ºMockå›è°ƒ
    callback_called = []
    
    def mock_callback(data, task_id, param, tick):
        callback_called.append({
            'data': data,
            'task_id': task_id,
            'tick': tick
        })
    
    # åˆ›å»ºä»»åŠ¡
    task = QtDownloadTask()
    task.downloadCompleteBack = mock_callback
    task.saveData = b"processed_data"
    
    # æ¨¡æ‹Ÿä»»åŠ¡å®Œæˆ
    task.downloadCompleteBack(task.saveData, 1001, None, 2.5)
    
    # éªŒè¯å›è°ƒè¢«è°ƒç”¨
    assert len(callback_called) == 1
    assert callback_called[0]['task_id'] == 1001
```

### Mockçš„å·¥ä½œåŸç†
```
1. åˆ›å»ºå‡å¯¹è±¡ (Mock)
2. å®šä¹‰å‡å¯¹è±¡çš„è¡Œä¸º (return_value)
3. ç”¨å‡å¯¹è±¡æ›¿æ¢çœŸå®å¯¹è±¡
4. æ‰§è¡Œæµ‹è¯•
5. éªŒè¯å‡å¯¹è±¡æ˜¯å¦è¢«æ­£ç¡®è°ƒç”¨
6. æµ‹è¯•å®Œæˆåæ¢å¤çœŸå®å¯¹è±¡
```

### å®é™…è¿ç”¨ - ä½ çš„é¡¹ç›®

#### mock_config Fixture
```python
@pytest.fixture
def mock_config():
    """æ¨¡æ‹Ÿé…ç½®å¯¹è±¡"""
    from conf import config
    original_can_waifu2x = config.CanWaifu2x
    
    # Mock: ç¦ç”¨GPUï¼Œé¿å…æµ‹è¯•ä¾èµ–ç¡¬ä»¶
    config.CanWaifu2x = False
    
    yield config
    
    # æ¢å¤: æµ‹è¯•åè¿˜åŸ
    config.CanWaifu2x = original_can_waifu2x
```

**ä½¿ç”¨**:
```python
def test_task_id_increment(self, mock_config):
    """ä½¿ç”¨mock_configï¼Œæµ‹è¯•æ—¶ä¸éœ€è¦GPU"""
    from src.qt.util.qttask import QtTask
    
    task_manager = QtTask()
    # æµ‹è¯•ä»»åŠ¡IDé€»è¾‘ï¼Œä¸æ¶‰åŠçœŸå®GPUå¤„ç†
    assert task_manager.taskId >= 0
```

### Mockçš„ä¸‰ç§å¸¸ç”¨æ–¹å¼

#### 1. Mockå¯¹è±¡
```python
from unittest.mock import Mock

mock_obj = Mock()
mock_obj.method.return_value = "fake_result"
result = mock_obj.method()
assert result == "fake_result"
```

#### 2. MagicMock (è‡ªåŠ¨Mockæ‰€æœ‰å±æ€§)
```python
from unittest.mock import MagicMock

mock_obj = MagicMock()
mock_obj.any_method()  # è‡ªåŠ¨è¿”å›Mockå¯¹è±¡
mock_obj.any_attribute  # è‡ªåŠ¨è¿”å›Mockå¯¹è±¡
```

#### 3. patchè£…é¥°å™¨ (ä¸´æ—¶æ›¿æ¢)
```python
from unittest.mock import patch

@patch('src.qt.util.qttask.QtTask.AddConvertTask')
def test_task_submission(self, mock_add_task):
    """ä¸´æ—¶æ›¿æ¢AddConvertTaskæ–¹æ³•"""
    mock_add_task.return_value = 1001
    
    # è°ƒç”¨è¢«æ›¿æ¢çš„æ–¹æ³•
    task_id = mock_add_task(b"data", {}, callback)
    
    assert task_id == 1001
    # æµ‹è¯•å®Œæˆåè‡ªåŠ¨æ¢å¤åŸæ–¹æ³•
```

### ä¼˜åŠ¿
âœ… **éš”ç¦»ä¾èµ–**: ä¸éœ€è¦GPUã€ç½‘ç»œã€æ•°æ®åº“
âœ… **æµ‹è¯•å¿«é€Ÿ**: ç§’çº§å®Œæˆï¼Œä¸ç­‰å¾…å¤–éƒ¨èµ„æº
âœ… **æµ‹è¯•ç¨³å®š**: ä¸å—å¤–éƒ¨ç¯å¢ƒå½±å“
âœ… **å¯æ§æ€§å¼º**: å¯ä»¥æ¨¡æ‹Ÿä»»ä½•åœºæ™¯(æˆåŠŸã€å¤±è´¥ã€å¼‚å¸¸)

---

## å››ã€ä¿¡å·æµ‹è¯• (Qt Signal Testing)

### åŸç†
**éªŒè¯Qtä¿¡å·æ§½æœºåˆ¶æ˜¯å¦æ­£ç¡®å·¥ä½œ**

### Qtä¿¡å·æ§½æœºåˆ¶å›é¡¾
```python
# å®šä¹‰ä¿¡å·
class QtTaskQObject(QObject):
    convertBack = Signal(int)  # ä¿¡å·: å‘é€intç±»å‹æ•°æ®

# è¿æ¥ä¿¡å·åˆ°æ§½å‡½æ•°
def slot_function(task_id):
    print(f"æ”¶åˆ°ä»»åŠ¡ID: {task_id}")

task_obj = QtTaskQObject()
task_obj.convertBack.connect(slot_function)

# å‘å°„ä¿¡å·
task_obj.convertBack.emit(1001)  # è§¦å‘slot_function(1001)
```

### é—®é¢˜åœºæ™¯
åœ¨ä½ çš„é¡¹ç›®ä¸­:
```
ä»»åŠ¡å®Œæˆ â†’ å‘å°„ä¿¡å· â†’ è§¦å‘å›è°ƒ â†’ æ›´æ–°UI
```

éœ€è¦æµ‹è¯•:
1. ä¿¡å·æ˜¯å¦æ­£ç¡®å®šä¹‰ï¼Ÿ
2. ä¿¡å·èƒ½å¦æ­£ç¡®è¿æ¥ï¼Ÿ
3. ä¿¡å·å‘å°„åæ§½å‡½æ•°æ˜¯å¦è¢«è°ƒç”¨ï¼Ÿ
4. ä¼ é€’çš„å‚æ•°æ˜¯å¦æ­£ç¡®ï¼Ÿ

### ä¼ ç»Ÿæ–¹å¼ (æ‰‹åŠ¨éªŒè¯)
```python
# æ‰‹åŠ¨è¿è¡Œç¨‹åºï¼Œè§‚å¯ŸUIæ˜¯å¦æ›´æ–°
# é—®é¢˜: æ…¢ã€ä¸å¯é ã€æ— æ³•è‡ªåŠ¨åŒ–
```

### ä¿¡å·æµ‹è¯•æ–¹å¼ (è‡ªåŠ¨åŒ–)

#### 1. æµ‹è¯•ä¿¡å·å®šä¹‰
```python
def test_signal_definition(self, qapp):
    """æµ‹è¯•ä¿¡å·æ˜¯å¦æ­£ç¡®å®šä¹‰"""
    from src.qt.util.qttask import QtTaskQObject
    from PySide6.QtCore import Signal
    
    task_obj = QtTaskQObject()
    
    # éªŒè¯ä¿¡å·å­˜åœ¨
    assert hasattr(task_obj, 'convertBack')
    
    # éªŒè¯æ˜¯Signalç±»å‹
    assert isinstance(type(task_obj).convertBack, Signal)
```

#### 2. æµ‹è¯•ä¿¡å·è¿æ¥
```python
def test_signal_connection(self, qapp):
    """æµ‹è¯•ä¿¡å·è¿æ¥"""
    from src.qt.util.qttask import QtTaskQObject
    
    task_obj = QtTaskQObject()
    
    # åˆ›å»ºæ§½å‡½æ•°ï¼Œè®°å½•æ¥æ”¶åˆ°çš„å€¼
    received_values = []
    
    def slot_function(task_id):
        received_values.append(task_id)
    
    # è¿æ¥ä¿¡å·
    task_obj.convertBack.connect(slot_function)
    
    # å‘å°„ä¿¡å·
    task_obj.convertBack.emit(1001)
    
    # å¤„ç†äº‹ä»¶å¾ªç¯ (é‡è¦!)
    qapp.processEvents()
    
    # éªŒè¯æ§½å‡½æ•°è¢«è°ƒç”¨
    assert len(received_values) == 1
    assert received_values[0] == 1001
```

#### 3. æµ‹è¯•å¤šæ¬¡ä¿¡å·å‘å°„
```python
def test_multiple_signal_emissions(self, qapp):
    """æµ‹è¯•å¤šæ¬¡ä¿¡å·å‘å°„"""
    from src.qt.util.qttask import QtTaskQObject
    
    task_obj = QtTaskQObject()
    received_values = []
    
    def slot_function(task_id):
        received_values.append(task_id)
    
    task_obj.convertBack.connect(slot_function)
    
    # å‘å°„å¤šæ¬¡
    for i in range(5):
        task_obj.convertBack.emit(1000 + i)
    
    qapp.processEvents()
    
    # éªŒè¯æ‰€æœ‰ä¿¡å·éƒ½è¢«æ¥æ”¶
    assert len(received_values) == 5
    assert received_values == [1000, 1001, 1002, 1003, 1004]
```

### å…³é”®ç‚¹: qapp.processEvents()

#### ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ
Qtä¿¡å·æ˜¯**å¼‚æ­¥**çš„ï¼Œä¿¡å·å‘å°„åä¸ä¼šç«‹å³æ‰§è¡Œæ§½å‡½æ•°ï¼Œè€Œæ˜¯æ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ã€‚

```python
task_obj.convertBack.emit(1001)  # ä¿¡å·è¿›å…¥é˜Ÿåˆ—
# æ­¤æ—¶æ§½å‡½æ•°è¿˜æ²¡æ‰§è¡Œ!

qapp.processEvents()  # å¤„ç†äº‹ä»¶é˜Ÿåˆ—ï¼Œæ‰§è¡Œæ§½å‡½æ•°
# ç°åœ¨æ§½å‡½æ•°æ‰§è¡Œäº†
```

#### å·¥ä½œåŸç†
```
1. emit(1001) â†’ ä¿¡å·è¿›å…¥Qtäº‹ä»¶é˜Ÿåˆ—
2. qapp.processEvents() â†’ å¤„ç†é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰äº‹ä»¶
3. æ§½å‡½æ•°è¢«è°ƒç”¨ â†’ slot_function(1001)
4. received_values.append(1001) â†’ è®°å½•ç»“æœ
5. assertéªŒè¯ â†’ æ£€æŸ¥ç»“æœ
```

### å®é™…è¿ç”¨ - ä¿¡å·åˆ°å›è°ƒçš„å®Œæ•´æµç¨‹
```python
def test_signal_to_callback_flow(self, qapp, mock_config):
    """æµ‹è¯•ä¿¡å·åˆ°å›è°ƒçš„å®Œæ•´æµç¨‹"""
    from src.qt.util.qttask import QtTask, QtDownloadTask
    
    task_manager = QtTask()
    
    # è®°å½•å›è°ƒè°ƒç”¨
    callback_results = []
    
    def test_callback(data, task_id, param, tick):
        callback_results.append(task_id)
    
    # åˆ›å»ºä»»åŠ¡
    task = QtDownloadTask()
    task.downloadId = 2001
    task.downloadCompleteBack = test_callback
    task.saveData = b"test"
    task.tick = 1.0
    task_manager.convertLoad[2001] = task
    
    # æ¨¡æ‹ŸHandlerConvertTaskçš„é€»è¾‘
    if 2001 in task_manager.convertLoad:
        info = task_manager.convertLoad[2001]
        # è°ƒç”¨å›è°ƒ
        info.downloadCompleteBack(info.saveData, 2001, None, info.tick)
        # æ¸…ç†ä»»åŠ¡
        del task_manager.convertLoad[2001]
    
    # éªŒè¯
    assert len(callback_results) == 1
    assert callback_results[0] == 2001
    assert 2001 not in task_manager.convertLoad  # ä»»åŠ¡å·²æ¸…ç†
```

### ä¼˜åŠ¿
âœ… **è‡ªåŠ¨éªŒè¯**: æ— éœ€æ‰‹åŠ¨è¿è¡Œç¨‹åºè§‚å¯Ÿ
âœ… **å¿«é€Ÿåé¦ˆ**: ç§’çº§å®Œæˆæµ‹è¯•
âœ… **è¦†ç›–å…¨é¢**: æµ‹è¯•å„ç§ä¿¡å·åœºæ™¯
âœ… **é˜²æ­¢å›å½’**: ä¿®æ”¹ä»£ç åç¡®ä¿ä¿¡å·æœºåˆ¶ä¸è¢«ç ´å

---

## äº”ã€å››ç§æŠ€æœ¯çš„ç»„åˆè¿ç”¨

### å®é™…æ¡ˆä¾‹: æµ‹è¯•ä»»åŠ¡ç®¡ç†å™¨

```python
class TestTaskManagerIntegration:
    """ç»„åˆä½¿ç”¨å››ç§æŠ€æœ¯"""
    
    # ä½¿ç”¨Fixture: è‡ªåŠ¨å‡†å¤‡Qtç¯å¢ƒå’Œé…ç½®
    def test_complete_workflow(self, qapp, mock_config):
        """æµ‹è¯•å®Œæ•´å·¥ä½œæµç¨‹"""
        from src.qt.util.qttask import QtTask, QtDownloadTask
        
        task_manager = QtTask()
        completed_tasks = []
        
        # ä½¿ç”¨Mock: æ¨¡æ‹Ÿå›è°ƒå‡½æ•°
        def mock_callback(data, task_id, param, tick):
            completed_tasks.append(task_id)
        
        # ä½¿ç”¨å‚æ•°åŒ–: æµ‹è¯•å¤šä¸ªä»»åŠ¡
        task_ids = [4000, 4001, 4002, 4003, 4004]
        
        for task_id in task_ids:
            task = QtDownloadTask()
            task.downloadId = task_id
            task.downloadCompleteBack = mock_callback
            task_manager.convertLoad[task_id] = task
        
        # æ¨¡æ‹Ÿä»»åŠ¡å®Œæˆ
        for task_id in task_ids:
            task = task_manager.convertLoad[task_id]
            task.saveData = f"processed_{task_id}".encode()
            # ä½¿ç”¨ä¿¡å·æµ‹è¯•: éªŒè¯å›è°ƒè°ƒç”¨
            task.downloadCompleteBack(task.saveData, task_id, None, 1.0)
        
        # å¤„ç†äº‹ä»¶
        qapp.processEvents()
        
        # éªŒè¯
        assert len(completed_tasks) == 5
        assert sorted(completed_tasks) == task_ids
```

---

## å…­ã€æ€»ç»“å¯¹æ¯”

| æŠ€æœ¯ | è§£å†³çš„é—®é¢˜ | æ ¸å¿ƒä»·å€¼ | ä½¿ç”¨åœºæ™¯ |
|------|-----------|---------|---------|
| **å‚æ•°åŒ–æµ‹è¯•** | é‡å¤ä»£ç  | ä¸€æ¬¡ç¼–å†™ï¼Œå¤šæ¬¡è¿è¡Œ | æµ‹è¯•å¤šç»„ç›¸ä¼¼æ•°æ® |
| **Fixture** | é‡å¤å‡†å¤‡ä»£ç  | è‡ªåŠ¨å‡†å¤‡å’Œæ¸…ç† | æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ– |
| **Mock** | å¤–éƒ¨ä¾èµ– | éš”ç¦»ä¾èµ–ï¼Œå¿«é€Ÿæµ‹è¯• | æ›¿æ¢GPUã€ç½‘ç»œã€æ•°æ®åº“ |
| **ä¿¡å·æµ‹è¯•** | Qtå¼‚æ­¥æœºåˆ¶ | éªŒè¯ä¿¡å·æ§½æ­£ç¡®æ€§ | æµ‹è¯•äº‹ä»¶é©±åŠ¨é€»è¾‘ |

### è®°å¿†å£è¯€

**å‚æ•°åŒ–**: ä¸€ä¸ªæµ‹è¯•ï¼Œå¤šç»„æ•°æ®ï¼Œè‡ªåŠ¨å¾ªç¯
**Fixture**: è‡ªåŠ¨å‡†å¤‡ï¼Œè‡ªåŠ¨æ¸…ç†ï¼Œä¾èµ–æ³¨å…¥
**Mock**: å‡å¯¹è±¡ï¼ŒçœŸæµ‹è¯•ï¼Œéš”ç¦»ä¾èµ–
**ä¿¡å·æµ‹è¯•**: å‘å°„ä¿¡å·ï¼Œå¤„ç†äº‹ä»¶ï¼ŒéªŒè¯å›è°ƒ

---

## ä¸ƒã€å®æˆ˜å»ºè®®

### ä½•æ—¶ä½¿ç”¨å‚æ•°åŒ–ï¼Ÿ
- âœ… æµ‹è¯•ç›¸åŒé€»è¾‘çš„ä¸åŒè¾“å…¥
- âœ… è¾¹ç•Œå€¼æµ‹è¯• (æœ€å°å€¼ã€æœ€å¤§å€¼ã€é›¶å€¼)
- âœ… ç­‰ä»·ç±»æµ‹è¯• (æœ‰æ•ˆå€¼ã€æ— æ•ˆå€¼)

### ä½•æ—¶ä½¿ç”¨Fixtureï¼Ÿ
- âœ… å¤šä¸ªæµ‹è¯•éœ€è¦ç›¸åŒçš„å‡†å¤‡å·¥ä½œ
- âœ… éœ€è¦è‡ªåŠ¨æ¸…ç†èµ„æº
- âœ… æµ‹è¯•ä¾èµ–å¤–éƒ¨ç¯å¢ƒ (æ•°æ®åº“è¿æ¥ã€æ–‡ä»¶ç­‰)

### ä½•æ—¶ä½¿ç”¨Mockï¼Ÿ
- âœ… æµ‹è¯•ä¾èµ–å¤–éƒ¨èµ„æº (GPUã€ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿ)
- âœ… å¤–éƒ¨èµ„æºæ…¢ã€ä¸ç¨³å®š
- âœ… éœ€è¦æ¨¡æ‹Ÿé”™è¯¯åœºæ™¯ (ç½‘ç»œè¶…æ—¶ã€ç£ç›˜æ»¡ç­‰)

### ä½•æ—¶ä½¿ç”¨ä¿¡å·æµ‹è¯•ï¼Ÿ
- âœ… ä½¿ç”¨Qtä¿¡å·æ§½æœºåˆ¶
- âœ… æµ‹è¯•å¼‚æ­¥å›è°ƒ
- âœ… éªŒè¯äº‹ä»¶é©±åŠ¨é€»è¾‘

---

**æŒæ¡è¿™å››ç§æŠ€æœ¯ï¼Œä½ å°±èƒ½å†™å‡ºé«˜è´¨é‡çš„è‡ªåŠ¨åŒ–æµ‹è¯•ï¼** ğŸš€
